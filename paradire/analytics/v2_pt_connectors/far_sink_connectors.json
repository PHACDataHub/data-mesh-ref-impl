{
    "name": "far_sink_connectors",
    "config": {
        "_comment": "Sink configuration for Federated Analytics Requests",
        "connector.class": "streams.kafka.connect.sink.Neo4jSinkConnector",
        "key.converter": "io.confluent.connect.avro.AvroConverter",
        "key.converter.schema.registry.url": "http://schema-registry:8081",
        "value.converter": "io.confluent.connect.avro.AvroConverter",
        "value.converter.schema.registry.url": "http://schema-registry:8081",
        "errors.retry.timeout": "-1",
        "errors.retry.delay.max.ms": "1000",
        "errors.tolerance": "all",
        "errors.log.enable": true,
        "errors.log.include.messages": true,
        "neo4j.server.uri": "bolt://neo4j:7687",
        "neo4j.authentication.basic.username": "neo4j",
        "neo4j.authentication.basic.password": "phac@2023",
        "neo4j.encryption.enabled": false,
        "topics": "far_1,far_2,far_3,far_4,far_5,far_6,far_7,far_8,far_9",
        "neo4j.topic.cypher.far_1": "WITH event.request_id AS request_id, SPLIT(event.covid_cvx_list, ',') AS covid_cvx_list, DATE(even.start_date) AS start_date, event.period_length AS period_length, event.pt_list AS pt UNWIND RANGE(0, event.number_of_periods -1) AS period WITH request_id, pt, OPTIONAL MATCH (patient)-[]-(immunization:Immunization) WHERE immunization.code IN covid_cvx_list AND immunization.date >= start_date + DURATION({months: period * period_length}) AND immunization.date <= start_date + DURATION({months: (period + 1) * period_length}) WITH DISTINCT(patient) AS patient, request_id, pt, period_start, period_end, COUNT(immunization) AS immunization_count WITH DISTINCT(patient.zip) AS patient_zip, request_id, pt, period_start, period_end, CASE WHEN immunization_count >= 2 THEN 'Fully vaccinated' WHEN immunization_count = 1 THEN 'One-dosed' ELSE 'Unvaccinated' END AS patient_status, COUNT(*) AS status_count WITH request_id, pt, period_start, period_end, patient_zip, patient_status, status_count MATCH (patient:Patient {zip: patient_zip}) WITH request_id, pt, period_start, period_end, patient_zip, patient_status, status_count COUNT(patient) AS patient_count WITH request_id, pt, period_start, period_end, patient_zip, patient_status, status_count, patient_count, ROUND(status_count*10000.0 / patient_count)/100.0 AS status_percent CREATE (n:FAS_1) SET n.request_id = request_id, n.pt = pt, n.start_date = period_start, n.end_date = period_end, n.patient_zip = patient_zip, n.patient_count = patient_count, n.patient_status = patient_status, n.status_count = status_count, n.status_percent = status_percent, n.timestamp = apoc.date.currentTimestamp()",
        "neo4j.topic.cypher.far_2":"WITH event.request_id AS request_id, event.cvx_maps AS cvx_maps, entity.pt_list AS pt WITH request_id, pt, cvx_maps, KEYS(cvx_maps) AS cvx_codes MATCH (patient:Patient) WITH patient, request_id, pt, cvx_maps OPTIONAL MATCH (patient)-[]-(immunization:Immunization) WHERE immunization.code IN cvx_codes WITH DISTINCT(patient) AS patient, request_id, pt, cvx_maps, cvx_codes, COLLECT([immunization.code, immunization.date]) AS immunizations WITH patient, request_id, pt, cvx_codes, REDUCE(codes=[], e IN immunizations | codes + [e[0]]) AS administered_codes, REDUCE(codes=[], e IN immunizations | CASE WHEN patient.birth_date + DURATION({months: apoc.map.get(cvx_maps, e[0])}) < e[1] THEN codes + [e[0]] ELSE codes END ) AS missed_schedule_codes WITH patient, request_id, pt, [e IN cvx_codes WHERE NOT(e IN administered_codes)] + missed_schedule_codes AS missing_doses WITH DISTINCT(patient.zip) AS patient_zip, request_id, pt, COUNT(*) AS patient_count, COLLECT(missing_doses) AS list_of_missing_doses WITH request_id, pt, patient_zip, patient_count, apoc.coll.sort(apoc.coll.toSet(apoc.coll.flatten(codes))) AS missing_doses WITH request_id, pt, patient_zip, patient_count, missing_doses CREATE (n:FAS_2) SET n.request_id = request_id, n.pt = pt, n.patient_zip = patient_zip, n.patient_count = patient_count, n.missing_doses = missing_doses, n.timestamp = apoc.date.currentTimestamp()",
        "neo4j.topic.cypher.far_3":"WITH event.request_id AS request_id, SPLIT(event.cvx_list, ',') AS cvx_list, event.pt_list AS pt WITH request_id, pt, MATCH (patient:Patient)-[]-(:Immunization)-[]-(:Encounter)-[]-(organization:Organization) WHERE immunization.code IN covid_cvx_list WITH request_id, pt, patient.zip AS zip, POINT.DISTANCE(patient.location, organization.location) AS distance, organization.name AS organization WITH DISTINCT([zip, organization]) AS zip_org, request_id, pt, SUM(distance)/COUNT(distance) AS average_distance WITH request_id, pt, zip_org[0] AS patient_zip, zip_org[1] AS organization_name, average_distance CREATE (n:FAS_3) SET n.request_id = request_id, n.pt = pt, n.patient_zip = patient_zip, n.organization_name = organization_name, n.average_distance = average_distance, n.timestamp = apoc.date.currentTimestamp()",
        "neo4j.topic.cypher.far_4":"WITH event.request_id AS request_id, SPLIT(event.cvx_list, ',') AS cvx_list, event.pt_list AS pt WITH request_id, pt, MATCH (patient:Patient)-[]-(:Immunization)-[]-(:Encounter)-[]-(organization:Organization) WHERE immunization.code IN covid_cvx_list WITH DISTINCT([patient.zip, organization.name]) AS zip_org, request_id, pt, COUNT(*) AS vaccination_count WITH request_id, pt, zip_org[0] AS patient_zip, zip_org[1] AS organization_name, vaccination_count CREATE (n:FAS_4) SET n.request_id = request_id, n.pt = pt, n.patient_zip = patient_zip, n.organization_name = organization_name, n.vaccination_count = vaccination_count, n.timestamp = apoc.date.currentTimestamp()",
        "neo4j.topic.cypher.far_5":"WITH 'MATCH (immunization:Immunization) WITH immunization ORDER BY immunization.date ASC RETURN immunization, \"' + event.request_id + '\" AS request_id, \"' + event.pt + '\" AS pt' AS batch_producer, 'WITH immunization, request_id, pt MATCH (organization:Organization)-[]-(encounter:Encounter)-[:IMMUNIZATION_OF_ENCOUNTER]-(immunization)-[:IMMUNIZATION_OF_PATIENT]-(patient:Patient) WITH immunization, organization, encounter, patient, request_id, pt CREATE (record:VaccinationRecord) SET record.request_id = request_id, record.pt = pt, record.immunization_date = TOSTRING(immunization.date), record.immunization_code = immunization.code, record.immunization_description = immunization.description, record.organization_name = organization.name, record.organization_zip = organization.zip, record.encounter_class = encounter.encounter_class, record.encounter_code = encounter.code, record.encounter_description = encounter.description, record.patient_id = patient.patient_id, record.patient_address = patient.address, record.patient_birth_date = TOSTRING(patient.birth_date), record.patient_alive = CASE WHEN patient.death_date IS NULL THEN TRUE ELSE FALSE END, record.patient_zip = patient.zip, record.patient_gender = patient.gender, record.patient_race = patient.race, record.patient_ethnicity = patient.ethnicity, record.timestamp = apoc.date.currentTimestamp()' AS batch_runner WITH batch_producer, batch_runner CALL apoc.periodic.iterate(batch_producer, batch_runner, {batchSize:10000, parallel:true}) YIELD total RETURN total",
        "neo4j.topic.cypher.far_6":"WITH event.request_id AS request_id, event.pt_list AS pt WITH request_id, pt MATCH (condition:Condition) WHERE NOT(condition.code IN ['314529007', '160903007', '160904001']) WITH DISTINCT(condition.description) AS condition_description, request_id, pt, COUNT(*) AS condition_count CREATE (n:FAS_6) SET n.request_id = request_id, n.pt = pt, n.condition_description = condition_description, n.condition_count = condition_count, n.timestamp = apoc.date.currentTimestamp()",
        "neo4j.topic.cypher.far_7":"WITH event.request_id AS request_id, event.pt_list AS pt WITH request_id, pt MATCH (medication:Medication) WITH DISTINCT(medication.reason_description) AS medication_reason_description request_id, pt, COUNT(*) AS medication_reason_count CREATE (n:FAS_7) SET n.request_id = request_id, n.pt = pt, n.medication_reason_description = medication_reason_description, n.medication_reason_count = medication_reason_count, n.timestamp = apoc.date.currentTimestamp()",
        "neo4j.topic.cypher.far_8":"WITH event.request_id AS request_id, event.pt_list AS pt WITH request_id, pt MATCH (procedure:Procedure) WITH DISTINCT(procedure.description) AS procedure_description request_id, pt, COUNT(*) AS procedure_count CREATE (n:FAS_8) SET n.request_id = request_id, n.pt = pt, n.procedure_description = procedure_description, n.procedure_count = procedure_count, n.timestamp = apoc.date.currentTimestamp()",
        "neo4j.topic.cypher.far_9":"WITH event.request_id AS request_id, event.cvx_maps AS cvx_maps, entity.pt_list AS pt WITH request_id, pt, cvx_maps, KEYS(cvx_maps) AS cvx_codes MATCH (patient:Patient) WITH patient, request_id, pt, cvx_maps OPTIONAL MATCH (patient)-[]-(immunization:Immunization) WHERE immunization.code IN cvx_codes WITH DISTINCT(patient) AS patient, request_id, pt, cvx_maps, cvx_codes, COLLECT([immunization.code, immunization.date]) AS immunizations WITH patient, request_id, pt, cvx_codes, REDUCE(codes=[], e IN immunizations | codes + [e[0]]) AS administered_codes, REDUCE(codes=[], e IN immunizations | CASE WHEN patient.birth_date + DURATION({months: apoc.map.get(cvx_maps, e[0])}) < e[1] THEN codes + [e[0]] ELSE codes END ) AS missed_schedule_codes WITH patient, request_id, pt, [e IN cvx_codes WHERE NOT(e IN administered_codes)] + missed_schedule_codes AS missing_doses WITH DISTINCT(patient.zip) AS patient_zip, request_id, pt, COUNT(*) AS patient_count, COLLECT(missing_doses) AS list_of_missing_doses WITH request_id, pt, patient_zip, patient_count, apoc.coll.sort(apoc.coll.toSet(apoc.coll.flatten(codes))) AS missing_doses WITH request_id, pt, patient_zip, patient_count, missing_doses OPTIONAL MATCH (patient)-[]-(:Immunization)-[]-(:Encounter)-[]-(organization:Organization) WHERE patient.zip = patient_zip WITH request_id, pt, patient_zip, patient_count, missing_doses, COLLECT(DISTINCT(organization)) AS organizations WITH request_id, pt, patient_zip, patient_count, missing_doses, organizations OPTIONAL MATCH (immunization:Immunization)-[]-(:Encounter)-[]-(organization:Organization) WHERE immunization.code IN missing_doses AND organization IN organizations WITH request_id, pt, patient_zip, patient_count, missing_doses, COLLECT(DISTINCT(organization.name)) AS organization_list CREATE (n:FAS_9) SET n.request_id = request_id, n.pt = pt, n.patient_zip = patient_zip, n.patient_count = patient_count, n.missing_doses = missing_doses, n.organization_list = CASE WHEN SIZE(organization_list) > 0 THEN TOSTRING(apoc.coll.sort(organization_list)) ELSE '' END, n.timestamp = apoc.date.currentTimestamp()"
    }
}
