<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Paradire Links</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/planb.css') }}"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>

  <body>
    <h1>Paradire Links</h1>
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th scope="col">Online</th>
          <th scope="col" style="width: 100%">Cluster</th>
          {% for service in services %}
          <th scope="col" style="white-space: nowrap">{{ service.name }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for cluster in clusters %}
        <tr>
          <td>
            <svg
              class="health-indicator"
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
            >
              <circle
                id="health-indicator-{{ cluster.alpha }}"
                cx="12"
                cy="12"
                r="10"
                fill="#808080"
              />
            </svg>
          </td>
          <td>{{ cluster.name }}</td>
          {% if cluster.fed %}
          <td colspan="3" class="text-center">
            <hr />
          </td>
          {% endif %} {% for service in services %} {% if not cluster.fed or
          service.fed %}
          <td class="text-center">
            <a
              href="{{ service.url | replace('$$', cluster.alpha) }}"
              target="_blank"
              title="{{ service.name }}"
              class="btn-icon {{ 'btn-' + service.name | replace(' ', '-') }}"
            >
              {% if service.icon %}
              <img
                src="{{ url_for('static', filename=service.icon) }}"
                alt="{{ service.name }} Icon"
                class="icon"
              />

              {% else %} {{ service.name }} {% endif %}
            </a>
          </td>
          {% endif %} {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script>
      function updateHealthStatus() {
          const clusters = [{{ clusters | map(attribute='alpha')|map("tojson")|join(",") }}];

          clusters.forEach((cluster) => {
            const indicator = document.getElementById(`health-indicator-${cluster}`);
            fetch(`/health-check/${cluster}`)
                .then(response => response.json())
                .then(data => {
                    const isProvinceHealthy = cluster in data && data[cluster] === "healthy";
                    if (isProvinceHealthy) {
                        indicator.setAttribute('fill', '#008000');
                    } else {
                        indicator.setAttribute('fill', '#FF0000');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    indicator.setAttribute('fill', '#FF0000');
                });
          });
      }
      updateHealthStatus();
      setInterval(updateHealthStatus, 300000);
    </script>
  </body>
</html>
